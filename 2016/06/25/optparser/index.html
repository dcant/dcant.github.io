<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>[Python] optparser | Talk is cheap, but I need it.</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Talk is cheap, but I need it.</a><span class="subtitle">dcant</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">主页</a><a href="/archives" class="sidebar-nav-item">归档</a><a href="/about" class="sidebar-nav-item">关于我</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>[Python] optparser</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2016-06-25</div></div></div><article><div class="container post"><p>源代码：<a href="https://hg.python.org/cpython/file/2.7/Lib/optparse.py" target="_blank" rel="external">optparse.py</a>  </p>
<blockquote>
<p>optparse是一个比getopt模块更加方便、灵活以及强大的用于解析命令行选项的库。它允许用户以传统的GNU/POSIX语法设置选项，并且会为用户生成用法及帮助信息。  </p>
</blockquote>
<h3 id="示例："><a href="#示例：" class="headerlink" title="示例："></a>示例：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from optparse import OptionParser</span><br><span class="line">...</span><br><span class="line">parser = OptionParser()</span><br><span class="line">parser.add_option(&quot;-f&quot;, &quot;--file&quot;, dest=&quot;filename&quot;,</span><br><span class="line">                  help=&quot;write report to FILE&quot;,</span><br><span class="line">                  metavar=&quot;FILE&quot;)</span><br><span class="line">parser.add_option(&quot;-q&quot;, &quot;--quiet&quot;,</span><br><span class="line">                  action=&quot;store_false&quot;, dest=&quot;verbose&quot;,</span><br><span class="line">                  default=True,</span><br><span class="line">                  help=&quot;don&apos;t print status messages to</span><br><span class="line">                  stdout&quot;)</span><br><span class="line"></span><br><span class="line">(options, args) = parser.parse_args()</span><br></pre></td></tr></table></figure>
<h3 id="optparse支持的选项类型"><a href="#optparse支持的选项类型" class="headerlink" title="optparse支持的选项类型"></a>optparse支持的选项类型</h3><p>支持两种类型：<br>-f ：可以多个选项连写，如-fv<br>–file</p>
<p>选项参数有两种表达方式：<br>-f arg<br>-file arg<br>或者<br>-farg<br>-file=arg<br>但是任一选项可能有参数也可能无参数，当出现-farg这样形式的选项时，解析器无法判断是四个选项f,a,r,g还是f选项带参数arg，造成二义，因此optparse不支持无参选项以避免歧义（参数默认bool类型除外，参见boolean选项处理）。</p>
<h3 id="快速上手"><a href="#快速上手" class="headerlink" title="快速上手"></a>快速上手</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from optparse import OptionParser</span><br><span class="line">...</span><br><span class="line">parser = OptionParser()</span><br></pre></td></tr></table></figure>
<p>创建OptionParser实例  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">parser.add_option(opt_str, ..., attr=value, ...)</span><br></pre></td></tr></table></figure>
<p>添加选项，选项为短选项(eg.-f)或长选项(eg.–file)，选项可设置任意多个，attr=value为选项属性设置(action, type, dest, help)  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(options, args) = parser.parse_args()</span><br></pre></td></tr></table></figure>
<p>执行解析操作<br>parse_args返回两个值：<br>options:包含选项的参数，options.file（.file默认为长选项名字<br>args:除选项参数外的位置参数，如exec -f arg –file arg arg1 arg2，arg1、arg2为位置参数</p>
<h3 id="选项属性"><a href="#选项属性" class="headerlink" title="选项属性"></a>选项属性</h3><h4 id="store-action"><a href="#store-action" class="headerlink" title="store action"></a>store action</h4><p>optparse中只有固定的几个硬编码的action，最常用的为store，当不设置action选项时，默认action便为store。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">parser.add_option(&quot;-f&quot;, &quot;--file&quot;, action=&quot;store&quot;,</span><br><span class="line">				type=&quot;string&quot;, dest=&quot;filename&quot;)</span><br><span class="line">args = [&quot;-f&quot;, &quot;foo.txt&quot;]</span><br><span class="line">(options, args) = parser.parse_args(args)</span><br></pre></td></tr></table></figure>
<p>当optparse看到选项-f，读取它之后的参数foo.txt，并将它存入options.filename中<br>optparse也支持int、float、long和complex类型，默认类型为string  </p>
<h4 id="flag选项"><a href="#flag选项" class="headerlink" title="flag选项"></a>flag选项</h4><p>optparse通过store_true和store_false两个action支持flag选项</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">parser.add_option(&quot;-v&quot;, action=&quot;store_true&quot;,</span><br><span class="line">				dest=&quot;verbose&quot;)</span><br><span class="line">parser.add_option(&quot;-q&quot;, action=&quot;store_false&quot;,</span><br><span class="line">				dest=&quot;verbose&quot;)</span><br></pre></td></tr></table></figure>
<p>通过-v选项将verbose设置为true，-q设置verbose为false。</p>
<h4 id="其他action"><a href="#其他action" class="headerlink" title="其他action"></a>其他action</h4><p>“store_const”：存储常量<br>“append”：将选项的参数添加到列表<br>“count”：将一个计数器加一  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">parser.add_option(&quot;-v&quot;, action=&quot;count&quot;, dest=&quot;verbosity&quot;)</span><br></pre></td></tr></table></figure>
<p>-v第一次出现时，optparse做如下处理:   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">options.verbosity = 0</span><br><span class="line">options.verbosity += 1</span><br></pre></td></tr></table></figure>
<p>以后-v每出现一次，verbosity均+1<br>“callback”：回调函数  </p>
<h4 id="默认值"><a href="#默认值" class="headerlink" title="默认值"></a>默认值</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">parser.add_option(&quot;-v&quot;, action=&quot;store_true&quot;,</span><br><span class="line">				dest=&quot;verbose&quot;, default=True)</span><br><span class="line">parser.add_option(&quot;-q&quot;, action=&quot;store_false&quot;,</span><br><span class="line">				dest=&quot;verbose&quot;)</span><br></pre></td></tr></table></figure>
<p>当-v和-q选项均不出现时，verbose默认为true<br>还可以以下述方式设置  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">parser.set_defaults(verbose=True)</span><br></pre></td></tr></table></figure>
<h4 id="生成帮助"><a href="#生成帮助" class="headerlink" title="生成帮助"></a>生成帮助</h4><p>可以通过help属性添加帮助信息  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">usage = &quot;usage: %prog [options] arg1 arg2&quot;</span><br><span class="line">parser = OptionParser(usage=usage)</span><br><span class="line">parser.add_option(&quot;-v&quot;, &quot;--verbose&quot;,</span><br><span class="line">                  action=&quot;store_true&quot;, dest=&quot;verbose&quot;,</span><br><span class="line">                  default=True,</span><br><span class="line">                  help=&quot;make lots of noise [default]&quot;)</span><br><span class="line">parser.add_option(&quot;-q&quot;, &quot;--quiet&quot;,</span><br><span class="line">                  action=&quot;store_false&quot;, dest=&quot;verbose&quot;,</span><br><span class="line">                  help=&quot;be vewwy quiet (I&apos;m hunting</span><br><span class="line">                  wabbits)&quot;)</span><br><span class="line">parser.add_option(&quot;-f&quot;, &quot;--filename&quot;,</span><br><span class="line">                  metavar=&quot;FILE&quot;, help=&quot;write output to</span><br><span class="line">                  FILE&quot;)</span><br><span class="line">parser.add_option(&quot;-m&quot;, &quot;--mode&quot;,</span><br><span class="line">                  default=&quot;intermediate&quot;,</span><br><span class="line">                  help=&quot;interaction mode: novice,</span><br><span class="line">                  intermediate, &quot;</span><br><span class="line">                  &quot;or expert [default: %default]&quot;)</span><br></pre></td></tr></table></figure>
<p>当命令行出现-h或–help选项，或者直接调用parser.print_help()方法时，输出如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Usage: &lt;yourscript&gt; [options] arg1 arg2</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -v, --verbose         make lots of noise [default]</span><br><span class="line">  -q, --quiet           be vewwy quiet (I&apos;m hunting</span><br><span class="line">                        wabbits)</span><br><span class="line">  -f FILE, --filename=FILE</span><br><span class="line">                        write output to FILE</span><br><span class="line">  -m MODE, --mode=MODE  interaction mode: novice,</span><br><span class="line">                        intermediate, or</span><br><span class="line">                        expert [default: intermediate]</span><br></pre></td></tr></table></figure>
<h4 id="Grouping选项"><a href="#Grouping选项" class="headerlink" title="Grouping选项"></a>Grouping选项</h4><p>使用grouping选项可以使帮助信息以更好的形式输出  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">group = OptionGroup(parser, &quot;Dangerous Options&quot;,</span><br><span class="line">                    &quot;Caution: use these options at your</span><br><span class="line">                    own risk.  &quot;</span><br><span class="line">                    &quot;It is believed that some of them</span><br><span class="line">                    bite.&quot;)</span><br><span class="line">group.add_option(&quot;-g&quot;, action=&quot;store_true&quot;, help=&quot;Group</span><br><span class="line">                    option.&quot;)</span><br><span class="line">parser.add_option_group(group)</span><br><span class="line"></span><br><span class="line">group = OptionGroup(parser, &quot;Debug Options&quot;)</span><br><span class="line">group.add_option(&quot;-d&quot;, &quot;--debug&quot;, action=&quot;store_true&quot;,</span><br><span class="line">                 help=&quot;Print debug information&quot;)</span><br><span class="line">group.add_option(&quot;-s&quot;, &quot;--sql&quot;, action=&quot;store_true&quot;,</span><br><span class="line">                 help=&quot;Print all SQL statements</span><br><span class="line">                 executed&quot;)</span><br><span class="line">group.add_option(&quot;-e&quot;, action=&quot;store_true&quot;, help=&quot;Print</span><br><span class="line">                every action done&quot;)</span><br><span class="line">parser.add_option_group(group)</span><br></pre></td></tr></table></figure>
<p>输出内容样式如下：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Usage: &lt;yourscript&gt; [options] arg1 arg2</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -h, --help            show this help message and exit</span><br><span class="line">  -v, --verbose         make lots of noise [default]</span><br><span class="line">  -q, --quiet           be vewwy quiet (I&apos;m hunting</span><br><span class="line">                        wabbits)</span><br><span class="line">  -f FILE, --filename=FILE</span><br><span class="line">                        write output to FILE</span><br><span class="line">  -m MODE, --mode=MODE  interaction mode: novice,</span><br><span class="line">                        intermediate, or expert</span><br><span class="line">                        [default: intermediate]</span><br><span class="line"></span><br><span class="line">  Dangerous Options:</span><br><span class="line">    Caution: use these options at your own risk.  It is</span><br><span class="line">    believed that some</span><br><span class="line">    of them bite.</span><br><span class="line"></span><br><span class="line">    -g                  Group option.</span><br><span class="line"></span><br><span class="line">  Debug Options:</span><br><span class="line">    -d, --debug         Print debug information</span><br><span class="line">    -s, --sql           Print all SQL statements executed</span><br><span class="line">    -e                  Print every action done</span><br></pre></td></tr></table></figure>
<h4 id="输出版本信息"><a href="#输出版本信息" class="headerlink" title="输出版本信息"></a>输出版本信息</h4><p>可通过version属性输出自己程序的版本信息。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">parser = OptionParser(usage=&quot;%prog [-f] [-q]&quot;,</span><br><span class="line">					version=&quot;%prog 1.0&quot;)</span><br></pre></td></tr></table></figure>
<p>假设脚本为/usr/bin/foo:  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ /usr/bin/foo --version</span><br><span class="line">foo 1.0</span><br></pre></td></tr></table></figure>
<p>OptionParser.print_version(file=None)<br>OptionParser.get_version()</p>
<h4 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h4><p>通过OptionParser.error()进入错误处理  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(options, args) = parser.parse_args()</span><br><span class="line">...</span><br><span class="line">if options.a and options.b:</span><br><span class="line">    parser.error(&quot;options -a and -b are mutually</span><br><span class="line">    exclusive&quot;)</span><br></pre></td></tr></table></figure>
<p>当-a和-b选项同时设置时，程序退出并输出error中的内容。</p>
</div><!-- comment system--><div class="container"><hr><div data-thread-key="2016/06/25/optparser/" data-title="[Python] optparser" data-url="https://dcant.github.io/2016/06/25/optparser/" class="ds-thread"></div><script>var duoshuoQuery = {short_name:'dcant'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="http://weibo.com/twtlove" target="_blank"><i class="fa fa-weibo"></i></a><a href="https://github.com/dcant" target="_blank"><i class="fa fa-github"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2016 <a href="/" rel="nofollow">Talk is cheap, but I need it.</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>